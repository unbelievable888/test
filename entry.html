<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport">
</head>
<body>


                    <button id="runBtn">
                        <span id="btnText">启动全流程分析</span>
                    </button>



            <!-- Right: Result Area -->
            <div class="col-span-12 lg:col-span-4 bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex flex-col h-[650px]">
                <h2 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10l4 4v10a2 2 0 01-2 2z"></path></svg>
                    推理分析简报 (Reasoner Result)
                </h2>
                <div id="resultArea" class="flex-grow overflow-y-auto prose prose-slate max-w-none pt-4 border-t border-slate-50">
                    <div class="flex flex-col items-center justify-center h-full text-slate-300">
                        <svg class="w-12 h-12 mb-2 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0012 18.75V19a2 2 0 11-4 0v-.25c0-1.031-.258-2.044-.752-2.906l-.547-.547z"/></svg>
                        <p class="text-sm">尚未开始推理</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * 核心类定义：整合 Planner 设计方案
         */

        class LLMClient {
            constructor(apiKey, baseUrl) {
                this.apiKey = apiKey;
                this.baseUrl = baseUrl || "https://api.openai.com/v1/chat/completions";
            }

            async ask(prompt, system, isJson = false) {
                const response = await fetch(this.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [{role: "system", content: system}, {role: "user", content: prompt}],
                        response_format: isJson ? { type: "json_object" } : undefined,
                        temperature: 0.1
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                }
                const data = await response.json();
                return data.choices[0].message.content;
            }
        }

        // --- UI 控制逻辑 ---
        const logger = {
            log: (msg, color = 'text-slate-300') => {
                const div = document.createElement('div');
                div.className = `mb-1 ${color}`;
                div.innerHTML = `<span class="text-slate-600">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
                const console = document.getElementById('logConsole');
                console.appendChild(div);
                console.scrollTop = console.scrollHeight;
            },
            success: (msg) => logger.log(msg, 'text-green-400'),
            info: (msg) => logger.log(msg, 'text-blue-300'),
            error: (msg) => logger.log(msg, 'text-red-400'),
            json: (obj) => {
                const pre = document.createElement('pre');
                pre.className = 'text-[10px] bg-slate-800 p-2 rounded my-2 text-yellow-200 overflow-x-auto';
                pre.textContent = JSON.stringify(obj, null, 2);
                document.getElementById('logConsole').appendChild(pre);
            }
        };

        function updateTaskUI(tasks) {
            const list = document.getElementById('statusList');
            list.innerHTML = tasks.map(t => `
                <div id="task-card-${t.id}" class="task-node p-3 border border-slate-200 rounded-xl flex items-center justify-between">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${t.tool === 'Text2SQL' ? 'bg-blue-100 text-blue-600' : t.tool === 'RAG' ? 'bg-purple-100 text-purple-600' : 'bg-slate-100 text-slate-600'}">${t.tool}</span>
                            <span class="text-sm font-medium text-slate-700">任务 #${t.id}</span>
                        </div>
                        <p class="text-[11px] text-slate-400 mt-1">${t.description}</p>
                    </div>
                    <div id="task-status-${t.id}" class="text-slate-300 italic text-[10px]">等待中</div>
                </div>
            `).join('');
        }

        function setTaskStatus(id, status, isDone = false) {
            const card = document.getElementById(`task-card-${id}`);
            const label = document.getElementById(`task-status-${id}`);
            if (label) label.innerHTML = status;
            if (isDone && card) card.classList.add('task-done', 'border-green-200');
        }

        // --- 主程序入口 (The Integration) ---

        async function main() {
            const apiKey = document.getElementById('apiKey').value;
            const proxyUrl = document.getElementById('proxyUrl').value;
            const userQuery = document.getElementById('userQuery').value;
            const runBtn = document.getElementById('runBtn');

            if (!apiKey) {
                logger.error("请先输入 API Key");
                return;
            }

            runBtn.disabled = true;
            document.getElementById('logConsole').innerHTML = '';
            document.getElementById('resultArea').innerHTML = '<div class="flex flex-col items-center justify-center h-full text-blue-500"><div class="loading-ring mb-2"></div><p class="text-sm">Agent 推理中...</p></div>';
            logger.info(">>> 启动 Agent Planner 系统驱动程序...");

            try {
                const client = new LLMClient(apiKey, proxyUrl);
                const resultsStore = {};

                // 1. 规划阶段 (Planner)
                logger.info("Planner: 正在分析用户意图并拆解子任务...");
                const planJson = await client.ask(
                    userQuery,
                    `你是一个专业数据分析规划员。
                    请将任务拆解为 JSON。必须包含 tasks 数组，每个任务包含: id, tool (Text2SQL/RAG/Final_Synthesis), description, subQuery, dependencies (数组)。
                    Text2SQL 负责定量数值，RAG 负责定性背景。`,
                    true
                );
                
                const plan = JSON.parse(planJson);
                logger.success("Planner: 任务 DAG 构造完成。");
                logger.json(plan);
                updateTaskUI(plan.tasks);

                // 2. 分层执行阶段 (Execution)
                // 先找没有依赖的任务 (Layer 1)
                const layer1 = plan.tasks.filter(t => t.dependencies.length === 0);
                logger.info(`Executor: 启动 Layer 1 并行任务 (${layer1.length}个)...`);

                await Promise.all(layer1.map(async (task) => {
                    setTaskStatus(task.id, '<div class="loading-ring"></div> 执行中');
                    logger.log(`[Task ${task.id}] 正在调用工具 ${task.tool}...`);
                    
                    // 这里模拟不同工具的调用，实际可替换为对应的 API
                    const toolResult = await client.ask(
                        `执行此子任务：${task.subQuery}。如果是SQL，请模拟返回几条关键销售数据；如果是RAG，请模拟返回一段财报策略背景。请直接返回简短的内容。`,
                        `你是一个 ${task.tool} 执行引擎。`
                    );
                    
                    resultsStore[task.id] = toolResult;
                    setTaskStatus(task.id, '已完成', true);
                    logger.success(`[Task ${task.id}] 获取到结果。`);
                }));

                // 3. 聚合推理阶段 (Reasoner)
                const synthesisTask = plan.tasks.find(t => t.tool === 'Final_Synthesis' || t.dependencies.length > 0);
                if (synthesisTask) {
                    logger.info(`Reasoner: 正在整合多源上下文进行因果分析...`);
                    setTaskStatus(synthesisTask.id, '<div class="loading-ring"></div> 综合推理中');

                    const context = Object.entries(resultsStore).map(([id, res]) => `[任务${id}结果]: ${res}`).join('\n');
                    const finalReport = await client.ask(
                        `基于以下多源数据生成深度报告：\n${context}\n\n原始需求：${userQuery}`,
                        "你是一个资深业务分析师，擅长将定量数据与定性背景结合。"
                    );

                    document.getElementById('resultArea').innerHTML = `
                        <div class="animate-in fade-in slide-in-from-bottom-2 duration-700">
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 text-xs text-blue-700">
                                <b>推理依据：</b> 已成功对齐 SQL 异常数据点与 RAG 文档背景。
                            </div>
                            <div class="text-slate-700 leading-relaxed text-sm space-y-4">
                                ${finalReport.split('\n').map(p => p.trim() ? `<p>${p}</p>` : '').join('')}
                            </div>
                        </div>
                    `;
                    setTaskStatus(synthesisTask.id, '已汇总', true);
                    logger.success("Reasoner: 报告生成完毕。");
                }

            } catch (err) {
                logger.error(`系统故障: ${err.message}`);
                document.getElementById('resultArea').innerHTML = `<div class="text-red-500 p-4 bg-red-50 rounded-lg text-sm">错误：${err.message}</div>`;
            } finally {
                runBtn.disabled = false;
                logger.info(">>> 引擎挂起。");
            }
        }

        document.getElementById('runBtn').addEventListener('click', main);
    </script>
</body>
</html>